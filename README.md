# Demo opnsense

## Intro

Terraform / opentofu reecepie to setup a self-service network for isolated VMs and OPNsense
Infomaniak public cloud service.

[https://www.infomaniak.com/en/hosting/public-cloud](https://www.infomaniak.com/en/hosting/public-cloud)
[https://opnsense.org/](https://opnsense.org/)

![diagram](diagram.png)

## Description

VMs like [vm-basic](vm-basic.tf) are in a self service private network
in our example, 192.168.120.0/24

They get `192.168.0.1` as default gateway and DNS server via DHCP

An OPNsense instance is deployed, with one interface attached to external public network
and one interface to the private network.

It is accessible on port 80, 443 on the `admin_prefixes` defined list,
and from anywhere via ICMP or port 52180 for wireguard.

## Infra setup

Setup openstack credentials, like with a `clouds.yaml` file, then

```shell
tofu init
tofu apply
```

This will create everything needed.

## Usage

Once setup, you have a working OPNsense instance and a local VM

To access the OPNsense get ip from outputs (opnsense_ip) and open your browser
login is root, [and password to get here](https://docs.infomaniak.cloud/tutorials/firewall/opnsense/#retrieve-administrator-password)

```shell
nova get-password opnsense sshkey
```

Setup the Wireguard in vpn/wireguard and appropriate rules

* Go to System / Settings / General
  DNS servers: 83.166.143.51, 83.166.143.52

* Go to Interfaces / Assignments and assign vtnet1 to desired named, like "Internal"

* Go to Services / Unbound DNS / General
  Network Interfaces: Internal
  check  Enable DNSSEC Support

* Go to Servies / Unbound DNS / Query Forwarding
  check  Use System Nameservers

* Go to Interaces / \[Internal\],
  enable interface
  IPv4 Configuration Type: Static IPv4
  IPv4 address: 192.168.120.1/24
  Save / Apply changes

* Go to VPN / Wireguard / Instances
  "+" to Add
  Name: wg-ext
  Public key: "*" to Generate new key pair
  Listen port: 51820
  Tunnel address: 192.168.101.1/24
  Save / Apply

* Go to VPN / Wireguard / Peer generator
  Endpoint: public ip you connect to:51820
  Name: your device
  Allowed IPs: 192.168.120.0/24
  Keepalive interval: 15
  Enable WireGuard: checked
  *copy data*
  Store and generate next

* Go to VPN / Wireguard / Peers
  Verify your device is here

* Connect your wireguard with the config you pasted before

* Go to Interfaces / Assignments
  assign interface to the wg0 interface
  description: WG-EXT

* Go to Firewall / Rules / WAN
  Add rule, Protocol TCP/UDP, destination "This Firewall", Destination port range, to: (other), 
  description: allow inbound connections to wireguard server

* Go to Firewall / Rules / WGEXT
  Add rule, Destination: Internal net

* Go to Firewall / Rules / Internal
  Add rule, leave to defaults

Apply !

There you can connect to the ip of the internal VM using the `sshkey` generated by terraform via ssh with user `debian` !
and the VM has automaticaly internet connectivity
